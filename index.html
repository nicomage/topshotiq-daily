<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TOP SHOT IQ ‚Äî DAILY</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Barlow:wght@400;500;600&family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #06070f;
    --surface:  #0c0e1a;
    --surface2: #111426;
    --border:   rgba(120,130,255,0.1);
    --accent:   #7b6fff;
    --accent-g: rgba(123,111,255,0.22);
    --cyan:     #4fc3f7;
    --violet:   #a855f7;
    --red:      #ef4444;
    --green:    #22c55e;
    --gold:     #f5c842;
    --text:     #eef0ff;
    --text2:    rgba(238,240,255,0.5);
    --muted:    #3d4460;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%;
    max-width: 480px;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
  }

  .logo-wrap { display:flex; flex-direction:column; gap:1px; }
  .logo-sup  { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.28em; color:var(--accent); text-transform:uppercase; }
  .logo-name { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:.06em; color:var(--text); }

  .hud { display:flex; gap:20px; align-items:center; }
  .hud-item { display:flex; flex-direction:column; align-items:center; gap:1px; }
  .hud-label { font-family:'DM Mono',monospace; font-size:8px; letter-spacing:.18em; color:var(--muted); text-transform:uppercase; }
  .hud-val   { font-family:'Bebas Neue',sans-serif; font-size:22px; line-height:1; color:var(--text); }
  .hud-val.accent { color:var(--accent); }
  .hud-val.streak { color:var(--violet); }

  main {
    width: 100%;
    max-width: 480px;
    padding: 16px 20px 40px;
    flex: 1;
  }

  @media (min-width: 900px) {
    header {
      max-width: 960px;
    }

    main {
      max-width: 960px;
      padding: 24px 20px 60px;
    }

    #gameScreen {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: 28px;
      align-items: start;
    }

    /* Left column : sticky */
    .left-col {
      position: sticky;
      top: 24px;
    }

    /* Right column : flex */
    .right-col {
      display: flex;
      flex-direction: column;
    }
  }

  .loading {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 60vh; gap: 14px;
  }
  .loading-spinner {
    width:36px; height:36px;
    border:2px solid var(--border); border-top-color:var(--accent);
    border-radius:50%; animation:spin .8s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg); } }
  .loading p { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.2em; color:var(--muted); text-transform:uppercase; }

  .date-strip {
    font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.22em;
    color:var(--muted); text-transform:uppercase; text-align:center; padding:10px 0 14px;
  }

  /* MOMENT CARD */
  .moment-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; overflow:hidden; margin-bottom:16px;
  }

  .moment-visual {
    width:100%; aspect-ratio:1;
    background:var(--surface2); position:relative; overflow:hidden;
  }

  .moment-visual img { width:100%; height:100%; object-fit:cover; display:block; }

  .moment-visual-placeholder {
    width:100%; height:100%; display:none;
    align-items:center; justify-content:center;
    font-family:'Bebas Neue',sans-serif; font-size:42px;
    letter-spacing:4px; color:var(--muted);
  }

  .moment-meta {
    padding:14px 16px; border-top:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:flex-start;
  }

  .moment-player { font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:.04em; color:var(--text); margin-bottom:2px; }
  .moment-team   { font-size:12px; color:var(--text2); font-weight:500; }

  .tier-pill {
    font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.12em;
    text-transform:uppercase; padding:3px 9px; border-radius:20px;
    border:1px solid currentColor; margin-top:2px;
  }
  .tier-legendary { color:var(--violet); }
  .tier-rare      { color:var(--cyan); }
  .tier-ultimate  { color:var(--gold); }
  .tier-common    { color:var(--muted); border-color:var(--muted); }

  /* TIMER */
  .timer-section { margin-bottom:14px; }
  .timer-row { display:flex; align-items:center; gap:10px; margin-bottom:6px; }
  .timer-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.2em; color:var(--muted); text-transform:uppercase; }
  .timer-num   { font-family:'DM Mono',monospace; font-size:13px; color:var(--muted); min-width:38px; text-align:right; }
  .timer-num.urgent { color:var(--red); }
  .timer-wrap  { flex:1; height:3px; background:var(--surface2); border-radius:2px; overflow:hidden; }
  .timer-bar   { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--cyan),var(--accent)); transition:width .1s linear; }
  .timer-bar.urgent { background:linear-gradient(90deg,var(--red),#f97316); }

  /* PROGRESS */
  .progress-section { margin-bottom:14px; }
  .progress-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .progress-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.2em; color:var(--muted); text-transform:uppercase; }
  .progress-score { font-family:'Bebas Neue',sans-serif; font-size:18px; color:var(--accent); letter-spacing:1px; }
  .question-dots { display:flex; gap:5px; }
  .qdot { width:7px; height:7px; border-radius:50%; background:var(--muted); transition:all .3s ease; }
  .qdot.active  { background:var(--accent); transform:scale(1.3); }
  .qdot.correct { background:var(--green); }
  .qdot.wrong   { background:var(--red); }

  /* QUESTION */
  .question-wrap {
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; padding:18px; margin-bottom:14px;
    animation:fadeUp .25s ease;
  }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(8px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .round-eye { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.22em; color:var(--muted); text-transform:uppercase; margin-bottom:8px; }
  .question-text { font-family:'Bebas Neue',sans-serif; font-size:22px; line-height:1.1; color:var(--text); margin-bottom:16px; }

  .options-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

  .opt-btn {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:10px; padding:12px 10px;
    color:var(--text); font-family:'Barlow Condensed',sans-serif;
    font-size:14px; font-weight:600; letter-spacing:.5px;
    cursor:pointer; transition:all .18s ease;
    text-align:center; min-height:48px;
    display:flex; align-items:center; justify-content:center; line-height:1.2;
  }
  .opt-btn:hover:not(:disabled) {
    border-color:rgba(120,130,255,0.4);
    background:var(--accent-g); transform:translateY(-1px);
  }
  .opt-btn.correct { border-color:var(--green); background:rgba(34,197,94,.12); color:var(--green); }
  .opt-btn.wrong   { border-color:var(--red);   background:rgba(239,68,68,.12);  color:var(--red); }
  .opt-btn:disabled { cursor:default; }

  /* BONUS PILLS */
  .bonus-row { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .bonus-pill {
    font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.12em;
    text-transform:uppercase; padding:4px 10px; border-radius:20px;
    display:flex; align-items:center; gap:5px;
    opacity:0; transition:opacity .3s;
  }
  .bonus-pill.show    { opacity:1; }
  .bonus-pill.correct { background:rgba(34,197,94,.12); color:var(--green); }
  .bonus-pill.speed   { background:rgba(79,195,247,.15); color:var(--cyan); }
  .bonus-pill.wrong   { background:rgba(239,68,68,.10); color:var(--red); }

  /* NEXT BTN */
  .next-btn {
    width:100%; background:linear-gradient(135deg,var(--accent),var(--violet));
    color:#fff; border:none; border-radius:10px; padding:15px;
    font-family:'Bebas Neue',sans-serif; font-size:19px; letter-spacing:3px;
    cursor:pointer; transition:all .18s ease; display:none; margin-top:14px;
  }
  .next-btn:hover { opacity:.88; transform:translateY(-1px); }
  .next-btn.show { display:block; }

  /* RESULTS ‚Äî plein √©cran par dessus tout */
  .results-screen {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg);
    overflow-y: auto;
    z-index: 100;
    padding: 24px 20px 60px;
  }
  .results-screen.show {
    display: block;
    animation: fadeUp .35s ease;
  }
  .results-inner {
    max-width: 480px;
    margin: 0 auto;
  }

  .results-title {
    font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.28em;
    color:var(--accent); text-transform:uppercase; text-align:center;
    margin-bottom:16px; padding-top:8px;
  }

  .score-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; padding:24px; text-align:center;
    margin-bottom:14px; position:relative; overflow:hidden;
  }
  .score-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg,var(--cyan),var(--accent),var(--violet));
  }
  .score-big {
    font-family:'Bebas Neue',sans-serif; font-size:72px; line-height:1;
    background:linear-gradient(115deg,var(--cyan),var(--accent),var(--violet));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:2px;
  }
  .score-sub { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.2em; color:var(--text2); text-transform:uppercase; margin-top:4px; }
  .score-points { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--accent); letter-spacing:1px; margin-top:8px; }
  .score-msg { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:600; color:var(--text); margin-top:6px; }

  /* RECAP */
  .recap-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; overflow:hidden; margin-bottom:14px;
  }
  .recap-head {
    font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.22em;
    color:var(--text2); text-transform:uppercase; padding:12px 16px;
    border-bottom:1px solid var(--border);
  }
  .recap-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 16px; border-bottom:1px solid var(--border);
  }
  .recap-row:last-child { border-bottom:none; }
  .recap-q { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.12em; color:var(--text2); text-transform:uppercase; }
  .recap-a { font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:600; color:var(--text); }
  .recap-a.ok  { color:var(--green); }
  .recap-a.bad { color:var(--red); }

  /* SHARE */
  .share-btn {
    width:100%; background:linear-gradient(135deg,var(--cyan),var(--accent));
    color:#fff; border:none; border-radius:10px; padding:16px;
    font-family:'Bebas Neue',sans-serif; font-size:20px; letter-spacing:3px;
    cursor:pointer; transition:all .18s ease; margin-bottom:10px;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .share-btn:hover { opacity:.88; transform:translateY(-1px); }
  .share-ok {
    text-align:center; font-family:'DM Mono',monospace; font-size:10px;
    letter-spacing:.2em; color:var(--green); text-transform:uppercase;
    opacity:0; transition:opacity .3s;
  }
  .share-ok.show { opacity:1; }

  /* COMEBACK */
  .comeback-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; padding:20px; text-align:center; margin-top:14px;
  }
  .comeback-title { font-family:'Bebas Neue',sans-serif; font-size:22px; letter-spacing:2px; color:var(--text); margin-bottom:4px; }
  .comeback-sub { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.18em; color:var(--text2); text-transform:uppercase; margin-bottom:14px; }
  .countdown-val {
    font-family:'Bebas Neue',sans-serif; font-size:34px; letter-spacing:4px;
    background:linear-gradient(90deg,var(--cyan),var(--accent));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .countdown-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.2em; color:var(--text2); text-transform:uppercase; margin-top:4px; }

  /* NO GAME */
  .no-game { text-align:center; padding:60px 20px; }
  .no-game h2 { font-family:'Bebas Neue',sans-serif; font-size:32px; letter-spacing:3px; color:var(--muted); margin-bottom:8px; }
  .no-game p  { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.15em; color:var(--muted); }
</style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <span class="logo-sup">Daily</span>
    <span class="logo-name">TOP SHOT IQ</span>
  </div>
  <div class="hud">
    <div class="hud-item">
      <span class="hud-label">Streak</span>
      <span class="hud-val streak" id="hudStreak">0üî•</span>
    </div>
    <div class="hud-item" id="comboDisplay" style="display:none">
      <span class="hud-label">Combo</span>
      <span class="hud-val" style="color:var(--cyan)" id="hudCombo">x1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Best</span>
      <span class="hud-val accent" id="hudBest">‚Äî</span>
    </div>
  </div>
</header>

<main>

  <div class="loading" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>Loading today's moment...</p>
  </div>

  <div id="gameScreen" style="display:none">
    <!-- LEFT COL (desktop) / full width (mobile) -->
    <div class="left-col">
      <div class="date-strip" id="dateStrip"></div>
      <div class="moment-card">
        <div class="moment-visual" id="momentVisual">
          <img id="momentImg" src="" alt="Moment"
            onload="this.style.display='block';document.getElementById('imgPlaceholder').style.display='none'"
            onerror="this.style.display='none';document.getElementById('imgPlaceholder').style.display='flex'"
            style="display:none">
          <div class="moment-visual-placeholder" id="imgPlaceholder" style="display:flex">TOP SHOT</div>
        </div>
        <div class="moment-meta">
          <div>
            <div class="moment-player" id="momentPlayer"></div>
            <div class="moment-team"   id="momentTeam"></div>
          </div>
          <div class="tier-pill" id="tierPill"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT COL (desktop) / full width (mobile) -->
    <div class="right-col">
      <div class="timer-section">
        <div class="timer-row">
          <span class="timer-label">Time</span>
          <div class="timer-wrap"><div class="timer-bar" id="timerBar"></div></div>
          <span class="timer-num" id="timerNum">15.0s</span>
        </div>
      </div>

      <div class="progress-section">
        <div class="progress-row">
          <span class="progress-label">Score</span>
          <span class="progress-score" id="progressScore">0 pts</span>
        </div>
        <div class="question-dots" id="qdots"></div>
      </div>

      <div class="question-wrap" id="questionWrap">
        <div class="round-eye" id="roundEye">Round 1 of 5</div>
        <div class="question-text" id="questionText"></div>
        <div class="options-grid" id="optionsGrid"></div>
        <div class="bonus-row" id="bonusRow"></div>
      </div>

      <button class="next-btn" id="nextBtn" onclick="nextQuestion()">NEXT ‚Üí</button>
    </div>
  </div>

  <div class="results-screen" id="resultsScreen">
    <div class="results-inner">
      <div class="results-title" id="resultsDate"></div>
      <div class="score-card">
        <div class="score-big" id="scoreBig"></div>
        <div class="score-sub">correct answers</div>
        <div class="score-points" id="scorePoints"></div>
        <div class="score-msg" id="scoreMsg"></div>
      </div>
      <div class="recap-card" id="recapCard">
        <div class="recap-head">Your Answers</div>
      </div>
      <button class="share-btn" onclick="shareResult()">
        <span>üìã</span> SHARE MY RESULT
      </button>
      <div class="share-ok" id="shareOk">Copied to clipboard!</div>
      <div class="comeback-card">
        <div class="comeback-title">Come Back Tomorrow</div>
        <div class="comeback-sub">New moment drops every day</div>
        <div class="countdown-val" id="countdownVal"></div>
        <div class="countdown-label">until next moment</div>
      </div>
    </div>
  </div>

  <div class="no-game" id="noGameScreen" style="display:none">
    <h2>No Moment Today</h2>
    <p>Check back soon</p>
  </div>

</main>

<script>
const SHEET = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwE6LdttbAmpRMiLSPBYZNuDxc0dbWVoe1IOvWLSKW_mCondhtvPJjrEGS_ZcmZazXIhX8gW9ZTtQn/pub';
const URLS = {
  daily:      SHEET+'?gid=1190927874&single=true&output=csv',
  sets:       SHEET+'?gid=0&single=true&output=csv',
  mintCounts: SHEET+'?gid=1682116080&single=true&output=csv',
  parallels:  SHEET+'?gid=829778745&single=true&output=csv',
};

const QUESTIONS = [
  { key:'set',       label:'Which SET is this moment from?' },
  { key:'series',    label:'Which SERIES does this moment belong to?' },
  { key:'mintCount', label:'What is the MINT COUNT of this edition?' },
  { key:'parallel',  label:'Which PARALLEL is this moment?' },
  { key:'topSale',   label:'What was the TOP SALE price?' },
];

const Q_TIME = 15;
const PTS_CORRECT = 100;
const PTS_SPEED_MAX = 50;
const COMBO_MULTIPLIERS = [1, 1.2, 1.5, 1.8, 2.2]; // x1 √† x2.2 selon streak

let G = {
  moment:null, db:{sets:[],mintCounts:{},parallels:[],series:[]},
  currentQ:0, answers:[], score:0, totalPts:0, timer:null, timeLeft:Q_TIME,
  combo:0, // streak de bonnes r√©ponses cons√©cutives
};

// CSV
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,''));
  return lines.slice(1).map(line=>{
    const vals=[]; let cur='',inQ=false;
    for(let c of line){
      if(c==='"')inQ=!inQ;
      else if(c===','&&!inQ){vals.push(cur.trim());cur='';}
      else cur+=c;
    }
    vals.push(cur.trim());
    const obj={};
    headers.forEach((h,i)=>obj[h]=(vals[i]||'').replace(/^"|"$/g,'').trim());
    return obj;
  });
}

async function fetchCSV(url) {
  const proxies = [
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    `https://thingproxy.freeboard.io/fetch/${url}`,
    `https://corsproxy.io/?${encodeURIComponent(url)}`,
  ];
  for (const proxy of proxies) {
    try {
      const r = await fetch(proxy);
      if (r.ok) return r.text();
    } catch(e) { continue; }
  }
  throw new Error('All proxies failed');
}

// Date utils
function todayStr() {
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
}
function normalizeDate(s){return s.replace(/-/g,'/');}
function displayDate(s){
  const p=s.replace(/-/g,'/').split('/');
  const M=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  return `${M[parseInt(p[1])-1]} ${parseInt(p[2])}, ${p[0]}`;
}

// Streak
function getStreak(){return parseInt(localStorage.getItem('tsiq_streak')||'0');}
function getBest()  {return parseInt(localStorage.getItem('tsiq_best')||'0');}

function updateStreak(played){
  const last=localStorage.getItem('tsiq_last_played');
  const today=todayStr();
  let streak=getStreak();
  if(last){
    const d1=new Date(last.replace(/\//g,'-'));
    const d2=new Date(today.replace(/\//g,'-'));
    const diff=(d2-d1)/(1000*60*60*24);
    if(diff===1)streak++;
    else if(diff>1)streak=played?1:0;
  } else { streak=played?1:0; }
  localStorage.setItem('tsiq_streak',streak);
  localStorage.setItem('tsiq_last_played',today);
  return streak;
}

function updateHUD(){
  const s=getStreak(),b=getBest();
  document.getElementById('hudStreak').textContent=s>0?s+'üî•':'0';
  document.getElementById('hudBest').textContent=b>0?b+' pts':'‚Äî';
}

// Load
async function loadData(){
  updateHUD();
  try{
    const [dailyT,setsT,mintT,parallelT]=await Promise.all([
      fetchCSV(URLS.daily),fetchCSV(URLS.sets),fetchCSV(URLS.mintCounts),fetchCSV(URLS.parallels)
    ]);

    const daily=parseCSV(dailyT);
    const today=todayStr();
    const row=daily.find(r=>normalizeDate(r.date)===today);
    if(!row){showNoGame();return;}
    G.moment=row;

    const setsData=parseCSV(setsT);
    G.db.sets=setsData;
    G.db.series=[...new Set(setsData.map(r=>r.Series).filter(Boolean))];

    mintT.trim().split('\n').forEach(line=>{
      const vals=line.split(',').map(v=>v.trim().replace(/^"|"$/g,''));
      if(vals[0])G.db.mintCounts[vals[0]]=vals.slice(1).filter(Boolean);
    });

    const pData=parseCSV(parallelT);
    const pKey=Object.keys(pData[0])[0];
    G.db.parallels=pData.map(r=>r[pKey]).filter(Boolean);

    const saved=localStorage.getItem('tsiq_'+today);
    if(saved){
      const p=JSON.parse(saved);
      G.answers=p.answers; G.score=p.score; G.totalPts=p.totalPts;
      showResults(); return;
    }
    startGame();
  }catch(e){
    console.error(e);
    showNoGame();
  }
}

// Start
function startGame(){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('gameScreen').style.display='block';
  const m=G.moment;
  document.getElementById('dateStrip').textContent=displayDate(m.date);

  // Image
  const img=document.getElementById('momentImg');
  if(m.imageURL&&m.imageURL.trim()){
    img.src=m.imageURL.trim();
  } else {
    img.style.display='none';
    document.getElementById('imgPlaceholder').style.display='flex';
  }

  document.getElementById('momentPlayer').textContent=m.playerName||'';
  document.getElementById('momentTeam').textContent=m.playerTeam||'';

  const tier=(m.tier||'Common').toLowerCase();
  const tierEl=document.getElementById('tierPill');
  tierEl.textContent=(m.tier||'Common').toUpperCase();
  tierEl.className='tier-pill tier-'+tier;

  const dotsEl=document.getElementById('qdots');
  dotsEl.innerHTML='';
  QUESTIONS.forEach((_,i)=>{
    const d=document.createElement('div');
    d.className='qdot'+(i===0?' active':'');
    d.id='qdot-'+i;
    dotsEl.appendChild(d);
  });

  showQuestion(0);
}

// Question
function showQuestion(idx){
  const q=QUESTIONS[idx];
  document.getElementById('roundEye').textContent=`Round ${idx+1} of ${QUESTIONS.length}`;
  document.getElementById('questionText').textContent=q.label;
  document.getElementById('progressScore').textContent=G.totalPts+' pts';

  QUESTIONS.forEach((_,i)=>{
    const d=document.getElementById('qdot-'+i);
    d.className='qdot';
    if(i<idx)d.classList.add(G.answers[i]?.correct?'correct':'wrong');
    else if(i===idx)d.classList.add('active');
  });

  const correct=getCorrect(q.key,G.moment);
  const wrongs=getWrongs(q.key,correct,G.moment.tier);
  const options=shuffle([correct,...wrongs.slice(0,3)]);

  const grid=document.getElementById('optionsGrid');
  grid.innerHTML='';
  options.forEach(opt=>{
    const btn=document.createElement('button');
    btn.className='opt-btn'; btn.textContent=opt;
    btn.onclick=()=>selectAnswer(btn,opt,correct,idx);
    grid.appendChild(btn);
  });

  document.getElementById('bonusRow').innerHTML='';
  document.getElementById('nextBtn').className='next-btn';

  const qw=document.getElementById('questionWrap');
  qw.style.animation='none';
  setTimeout(()=>qw.style.animation='fadeUp .25s ease',10);

  startTimer(idx,correct);
}

// Timer
function startTimer(qIdx,correct){
  clearInterval(G.timer);
  G.timeLeft=Q_TIME;
  updateTimerUI();
  G.timer=setInterval(()=>{
    G.timeLeft=Math.max(0,G.timeLeft-0.1);
    updateTimerUI();
    if(G.timeLeft<=0){
      clearInterval(G.timer);
      selectAnswer(null,'__timeout__',correct,qIdx,true);
    }
  },100);
}

function updateTimerUI(){
  const pct=(G.timeLeft/Q_TIME)*100;
  const urgent=G.timeLeft<5;
  document.getElementById('timerBar').style.width=pct+'%';
  document.getElementById('timerBar').className='timer-bar'+(urgent?' urgent':'');
  document.getElementById('timerNum').className='timer-num'+(urgent?' urgent':'');
  document.getElementById('timerNum').textContent=G.timeLeft.toFixed(1)+'s';
}

// Select answer
function selectAnswer(btn,chosen,correct,qIdx,timeout=false){
  clearInterval(G.timer);
  const isCorrect=chosen===correct;

  // Calcul des points avec combo
  const comboIdx=Math.min(G.combo, COMBO_MULTIPLIERS.length-1);
  const multiplier=isCorrect?COMBO_MULTIPLIERS[comboIdx]:1;
  const speedBonus=isCorrect?Math.round(PTS_SPEED_MAX*(G.timeLeft/Q_TIME)):0;
  const basePts=isCorrect?PTS_CORRECT:0;
  const comboPts=isCorrect?Math.round(basePts*multiplier)-basePts:0;
  const pts=basePts+comboPts+speedBonus;

  G.totalPts+=pts;
  if(isCorrect){ G.score++; G.combo++; }
  else { G.combo=0; }

  G.answers[qIdx]={chosen,correct,correct:isCorrect,pts,speedBonus,comboPts,multiplier};

  document.querySelectorAll('.opt-btn').forEach(b=>{
    b.disabled=true;
    if(b.textContent===correct)b.classList.add('correct');
  });
  if(btn&&!isCorrect)btn.classList.add('wrong');

  const row=document.getElementById('bonusRow');
  row.innerHTML='';
  if(timeout){
    addPill(row,"‚è± Time's up!",'wrong');
    addPill(row,'Correct: '+correct,'wrong');
    G.combo=0;
  } else if(isCorrect){
    addPill(row,'‚úì Correct!','correct');
    if(comboPts>0)addPill(row,'üî• x'+multiplier.toFixed(1)+' combo +'+comboPts,'speed');
    if(speedBonus>0)addPill(row,'‚ö° +'+speedBonus+' speed','speed');
    addPill(row,'+'+pts+' pts','correct');
  } else {
    addPill(row,'‚úó Wrong ‚Äî combo reset','wrong');
    addPill(row,'Correct: '+correct,'wrong');
  }

  document.getElementById('progressScore').textContent=G.totalPts+' pts';
  // Afficher le combo actuel dans le header si > 1
  updateComboDisplay();

  const nb=document.getElementById('nextBtn');
  nb.className='next-btn show';
  nb.textContent=qIdx<QUESTIONS.length-1?'NEXT ‚Üí':'SEE RESULTS ‚Üí';
}

function addPill(row,text,type){
  const p=document.createElement('div');
  p.className='bonus-pill '+type;
  p.textContent=text;
  row.appendChild(p);
  setTimeout(()=>p.classList.add('show'),50);
}

function updateComboDisplay(){
  const el=document.getElementById('comboDisplay');
  const val=document.getElementById('hudCombo');
  if(G.combo>=2){
    el.style.display='flex';
    const mult=COMBO_MULTIPLIERS[Math.min(G.combo,COMBO_MULTIPLIERS.length-1)];
    val.textContent='x'+mult.toFixed(1);
  } else {
    el.style.display='none';
  }
}

function nextQuestion(){
  G.currentQ++;
  if(G.currentQ>=QUESTIONS.length)finishGame();
  else showQuestion(G.currentQ);
}

function finishGame(){
  const today=todayStr();
  localStorage.setItem('tsiq_'+today,JSON.stringify({
    answers:G.answers,score:G.score,totalPts:G.totalPts,date:today
  }));
  updateStreak(true);
  const best=Math.max(getBest(),G.totalPts);
  localStorage.setItem('tsiq_best',best);
  updateHUD();
  showResults();
}

function showResults(){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('gameScreen').style.display='none';
  document.getElementById('noGameScreen').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('resultsScreen').className='results-screen show';

  document.getElementById('resultsDate').textContent=displayDate(G.moment.date);
  document.getElementById('scoreBig').textContent=G.score+'/5';
  document.getElementById('scorePoints').textContent=G.totalPts+' pts';

  const msgs=['Keep studying! üìö','Getting there! üèÄ','Not bad! üëä','Solid knowledge! üî•','Almost perfect! ‚ö°','IMMACULATE! üèÜ'];
  document.getElementById('scoreMsg').textContent=msgs[G.score]||msgs[0];

  // Recap avec vrais labels
  const recap=document.getElementById('recapCard');
  recap.innerHTML='<div class="recap-head">Your Answers</div>';
  const labels={set:'SET',series:'SERIES',mintCount:'MINT COUNT',parallel:'PARALLEL',topSale:'TOP SALE'};
  QUESTIONS.forEach((q,i)=>{
    const a=G.answers[i]; if(!a)return;
    const row=document.createElement('div');
    row.className='recap-row';
    let ptsDetail='';
    if(a.correct){
      ptsDetail=` <span style="color:var(--accent);font-size:11px">+${a.pts}pts`;
      if(a.comboPts>0)ptsDetail+=` (x${a.multiplier.toFixed(1)})`;
      ptsDetail+='</span>';
    }
    row.innerHTML=`
      <span class="recap-q">${labels[q.key]||q.key}</span>
      <span class="recap-a ${a.correct?'ok':'bad'}">${a.correct?'‚úì '+a.correct:'‚úó '+a.chosen+' ‚Üí '+a.correct}${ptsDetail}</span>
    `;
    recap.appendChild(row);
  });

  // Lien vers le moment
  if(G.moment.momentURL&&G.moment.momentURL.trim()){
    const linkRow=document.createElement('div');
    linkRow.style.cssText='padding:12px 16px;border-top:1px solid var(--border);text-align:center;';
    linkRow.innerHTML=`<a href="${G.moment.momentURL.trim()}" target="_blank" style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.18em;color:var(--accent);text-transform:uppercase;text-decoration:none;">
      VIEW MOMENT ON TOP SHOT ‚Üó
    </a>`;
    recap.appendChild(linkRow);
  }

  updateCountdown();
  setInterval(updateCountdown,1000);
}

function updateCountdown(){
  const now=new Date(),tom=new Date(now);
  tom.setDate(tom.getDate()+1);tom.setHours(0,0,0,0);
  const d=tom-now;
  const h=Math.floor(d/3600000),m=Math.floor((d%3600000)/60000),s=Math.floor((d%60000)/1000);
  document.getElementById('countdownVal').textContent=
    String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

function shareResult(){
  const emojis=G.answers.map(a=>a.correct?'üü©':'üü•').join('');
  const text=`TOP SHOT IQ ‚Äî ${displayDate(G.moment.date)}\n${G.score}/5 ‚Ä¢ ${G.totalPts} pts\n${emojis}\ntopshotiq.com`;
  navigator.clipboard.writeText(text).then(()=>{
    const el=document.getElementById('shareOk');
    el.className='share-ok show';
    setTimeout(()=>el.className='share-ok',2500);
  });
}

// Correct/Wrong answers
function getCorrect(key,m){
  if(key==='set')return m.set||'';
  if(key==='series')return m.series||'';
  if(key==='mintCount')return m.mintCount||'';
  if(key==='parallel')return m.parallel||'Standard';
  if(key==='topSale')return(m.topSale||'').trim();
  return '';
}

function getWrongs(key,correct,tier){
  let pool=[];
  if(key==='set'){
    pool=G.db.sets.filter(r=>r.Tier===tier&&r.SetName&&r.SetName!==correct).map(r=>r.SetName);
  } else if(key==='series'){
    pool=G.db.series.filter(s=>s!==correct);
  } else if(key==='mintCount'){
    pool=(G.db.mintCounts[tier]||[]).filter(m=>m!==correct);
  } else if(key==='parallel'){
    pool=G.db.parallels.filter(p=>p!==correct);
  } else if(key==='topSale'){
    return generatePriceOptions(correct);
  }
  return shuffle(pool).slice(0,3);
}

// Parse prix format europ√©en "$6 998,00" ‚Üí 6998
function parsePrice(str){
  if(!str)return NaN;
  return parseFloat(str.replace(/[$\s]/g,'').replace(',','.'));
}

// Format prix style europ√©en 6998 ‚Üí "$6 998,00"
function formatPrice(num){
  if(isNaN(num)||num<=0)return'$0,00';
  const parts=num.toFixed(2).split('.');
  const intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
  return'$'+intPart+','+parts[1];
}

function generatePriceOptions(correct){
  const num=parsePrice(correct);
  if(isNaN(num)||num<=0)return['$25,00','$100,00','$500,00'];

  const opts=new Set();
  const round=(v)=>{
    if(v>=1000)return Math.round(v/50)*50;
    if(v>=100) return Math.round(v/10)*10;
    if(v>=20)  return Math.round(v/5)*5;
    return Math.round(v);
  };

  const factors=shuffle([0.35,0.55,0.70,1.35,1.60,1.90,2.50,0.45]);
  for(const f of factors){
    if(opts.size>=3)break;
    const v=round(num*f);
    const formatted=formatPrice(v);
    if(v>0&&Math.abs(v-num)/num>0.15&&formatted!==correct){
      opts.add(formatted);
    }
  }
  while(opts.size<3){
    const v=round(num*(0.3+Math.random()*2));
    opts.add(formatPrice(v));
  }
  return[...opts];
}

function showNoGame(){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('noGameScreen').style.display='block';
}

function shuffle(a){
  const arr=[...a];
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

loadData();
</script>
</body>
</html>
